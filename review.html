<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Community Grants — Review Proposals</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --card:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
    --accent:#1d4ed8; --accent-2:#1e40af; --ok:#15803d; --warn:#b45309; --bad:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:12px;align-items:center;justify-content:space-between}
  h1{font-size:20px;margin:0}
  main.wrap{padding-top:24px;padding-bottom:48px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  .card h2{margin:0 0 12px 0;font-size:18px}
  .card h3{margin:10px 0 6px 0;font-size:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);outline:none;font-size:13px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;font-size:13px}
  .btn:hover{background:var(--accent-2)}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  .btn.sm{padding:6px 10px;font-size:12px;border-radius:999px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
  .status{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#fff;border:1px dashed var(--border);padding:10px;border-radius:10px}
  .muted{color:var(--muted);font-size:13px}
  small.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .logo-img {
    height: 50px;
    width: auto;
    display: block;
  }
  .brand {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .layout{
    display:grid;
    grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
    gap:16px;
  }
  @media(max-width:900px){
    .layout{grid-template-columns:1fr}
  }

  .list{
    max-height:420px;
    overflow:auto;
    border-radius:12px;
    border:1px solid var(--border);
    background:#fff;
  }
  .listRow{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:13px;
    cursor:pointer;
  }
  .listRow:nth-child(odd){background:#f9fafb}
  .listRow:hover{background:#eff6ff}
  .listRow.selected{background:#dbeafe}
  .listRowTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:6px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
  }
  .badge.submitted{background:#eff6ff;color:#1d4ed8}
  .badge.approved{background:#ecfdf3;color:#15803d}
  .badge.rejected{background:#fef2f2;color:#b91c1c}
  .badge.cancelled{background:#f3f4f6;color:#4b5563}
  .badge.funded{background:#f0fdf4;color:#15803d}
  .badge.draft{background:#f9fafb;color:#4b5563}
  .badge.youVoted{background:#fef9c3;color:#854d0e;margin-left:4px}
  .detailsGrid{
    font-size:13px;
    display:grid;
    grid-template-columns:minmax(0,1fr);
    gap:8px;
  }
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <img src="open_grant.png" alt="OpenGrant Logo" class="logo-img" />
    <div class="row" style="justify-content:flex-end;flex:1">
      <a href="index.html" class="btn secondary sm" style="text-decoration:none">Apply</a>
      <a href="review.html" class="btn secondary sm" style="text-decoration:none">Review</a>
      <a href="fund.html" class="btn secondary sm" style="text-decoration:none">Fund</a>
      <span class="pill" id="pillConn">
        <span class="dot"></span><span>Wallet: Not connected</span>
      </span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Review submitted proposals</h2>
    <p class="muted">
      Connect with a wallet that has <span class="code">REVIEWER_ROLE</span>. Select a proposal in
      the list on the left, then use <b>Approve</b> or <b>Reject</b>.
    </p>

    <div class="row" style="align-items:flex-end;margin-top:10px">
      <div style="flex:1;min-width:260px">
        <label>GrantProposal Contract Address</label>
        <input id="inAddr" placeholder="0x..." />
        <div class="muted" style="margin-top:4px">Same address as the Apply/Fund pages (stored locally).</div>
      </div>
      <div class="row" style="flex:0 0 auto">
        <button class="btn secondary" id="btnSaveAddr">Save</button>
        <button class="btn" id="btnConnect">Connect</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn secondary" id="btnReload">Reload proposals</button>
    </div>

    <div class="layout" style="margin-top:16px">
      <!-- left: list -->
      <div>
        <h3>Proposals</h3>
        <div id="list" class="list">
          <div class="muted" style="padding:10px 12px">Click “Reload proposals” to fetch on-chain data.</div>
        </div>
      </div>

      <!-- right: details -->
      <div>
        <h3>Details & Vote</h3>
        <div id="detailBox" class="status">Select a proposal from the list.</div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnApprove" disabled>Approve</button>
          <button class="btn secondary" id="btnReject" disabled>Reject</button>
        </div>
        <div id="voteHint" class="muted" style="margin-top:6px;font-size:12px"></div>

        <h3 style="margin-top:16px">Activity</h3>
        <div id="log" class="status">Ready.</div>
      </div>
    </div>
  </section>
</main>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.min.js";

  // --- ABI for reviewing ---
  const ABI = [
    "function proposalCount() view returns (uint256)",
    "function getProposal(uint256 id) view returns (address,string,string,uint256,uint64,uint8,uint32,uint32,bool)",
    "function hasVoted(uint256 id,address reviewer) view returns (bool)",
    "function review(uint256 id,bool approve)",
    "function REVIEWER_ROLE() view returns (bytes32)",
    "function hasRole(bytes32 role,address account) view returns (bool)"
  ];

  const STATUS = ["Draft","Submitted","Approved","Rejected","Cancelled","Funded"];

  const $ = (id) => document.getElementById(id);
  const log = (msg) => {
    const el = $("log");
    if (el) {
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent;
    }
  };
  const setConn = (text, color) => {
    const pill = $("pillConn");
    if (!pill) return;
    pill.children[1].textContent = text;
    pill.children[0].style.background = color ?? "#cbd5e1";
  };
  const saveAddr = (addr) => localStorage.setItem("GRANT_ADDR", addr);
  const loadAddr = () => localStorage.getItem("GRANT_ADDR") || "0x355e11a1146505ee29a04831142dd24ec54bb259";
  const fromWei = (wei) => ethers.formatEther(wei);

  const bind = (id, handler) => {
    const tryAttach = () => {
      const el = $(id);
      if (el) { el.addEventListener("click", handler, false); return true; }
      return false;
    };
    if (!tryAttach()) {
      const iv = setInterval(() => { if (tryAttach()) clearInterval(iv); }, 50);
      setTimeout(() => clearInterval(iv), 5000);
    }
  };

  let provider, signer, user, chainId;
  let isReviewer = false;
  let proposals = [];
  let selectedId = null;
  let contract;

  const asProposalObj = (id, p, hasVoted) => {
    return {
      id: Number(id),
      proposer: p[0],
      title: p[1],
      detailsURL: p[2],
      requestedAmount: fromWei(p[3]),
      reviewDeadline: Number(p[4]) ? new Date(Number(p[4]) * 1000) : null,
      rawStatusIndex: Number(p[5]),
      status: STATUS[p[5]] ?? `Unknown(${p[5]})`,
      approvals: Number(p[6]),
      rejections: Number(p[7]),
      paid: !!p[8],
      hasVoted: !!hasVoted
    };
  };

  const getContract = () => {
    const addrEl = $("inAddr");
    const addr = (addrEl?.value || "").trim();
    if (!ethers.isAddress(addr)) throw new Error("Invalid contract address");
    const signerOrProvider = signer || provider;
    if (!signerOrProvider) throw new Error("No provider available");
    return new ethers.Contract(addr, ABI, signerOrProvider);
  };

  async function ensureWallet() {
    if (!window.ethereum) {
      log("No injected wallet found. Install MetaMask and reload.");
      setConn("Wallet: No provider", "#ef4444");
      throw new Error("No provider");
    }
    if (!provider) {
      provider = new ethers.BrowserProvider(window.ethereum);
      if (provider.pollingInterval != null) provider.pollingInterval = 2000;
    }
    if (!signer) {
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      user = await signer.getAddress();
      const net = await provider.getNetwork();
      chainId = Number(net.chainId);
      setConn(`Wallet: ${user.slice(0,6)}…${user.slice(-4)} (chain ${chainId})`, "#22c55e");
      log(`Connected as ${user} on chain ${chainId}`);

      // After connect, check reviewer role (using current contract address, if valid)
      try {
        const addr = ($("inAddr")?.value || "").trim();
        if (ethers.isAddress(addr)) {
          const tmpContract = new ethers.Contract(addr, ABI, signer);
          const role = await tmpContract.REVIEWER_ROLE();
          isReviewer = await tmpContract.hasRole(role, user);
          log("Reviewer role for " + user + ": " + isReviewer);
        } else {
          log("Tip: save a valid contract address, then reload proposals.");
        }
      } catch (e) {
        console.error(e);
        log("Could not check reviewer role: " + (e?.reason || e?.message || e));
      }
    }
  }

  function renderList() {
    const listEl = $("list");
    if (!listEl) return;

    if (!proposals.length) {
      listEl.innerHTML = '<div class="muted" style="padding:10px 12px">No proposals found.</div>';
      return;
    }

    const rows = proposals.map((p) => {
      const badgeClass =
        p.status === "Submitted" ? "submitted" :
        p.status === "Approved"  ? "approved"  :
        p.status === "Rejected"  ? "rejected"  :
        p.status === "Cancelled" ? "cancelled" :
        p.status === "Funded"    ? "funded"    :
                                   "draft";

      const deadlineStr = p.reviewDeadline ? p.reviewDeadline.toLocaleDateString() : "-";
      const youVoted = p.hasVoted ? '<span class="badge youVoted">You voted</span>' : "";

      return `
        <div class="listRow ${selectedId === p.id ? "selected" : ""}" data-id="${p.id}">
          <div class="listRowTop">
            <div>
              #${p.id} — ${p.title || "(no title)"}
            </div>
            <div>
              <span class="badge ${badgeClass}">${p.status}</span>
              ${youVoted}
            </div>
          </div>
          <div class="muted">
            ${p.requestedAmount} ETH • approvals ${p.approvals} / rejections ${p.rejections} • deadline ${deadlineStr}
          </div>
        </div>
      `;
    }).join("");

    listEl.innerHTML = rows;
  }

  function renderDetails() {
    const detailBox = $("detailBox");
    const voteHint = $("voteHint");
    const btnApprove = $("btnApprove");
    const btnReject = $("btnReject");

    if (!detailBox || !btnApprove || !btnReject) return;

    if (!selectedId) {
      detailBox.textContent = "Select a proposal from the list.";
      btnApprove.disabled = true;
      btnReject.disabled = true;
      if (voteHint) voteHint.textContent = "";
      return;
    }

    const p = proposals.find((x) => x.id === selectedId);
    if (!p) {
      detailBox.textContent = "Selected proposal not found.";
      btnApprove.disabled = true;
      btnReject.disabled = true;
      if (voteHint) voteHint.textContent = "";
      return;
    }

    const obj = {
      id: p.id,
      proposer: p.proposer,
      title: p.title,
      detailsURL: p.detailsURL,
      requestedAmountETH: p.requestedAmount,
      reviewDeadline: p.reviewDeadline ? p.reviewDeadline.toLocaleString() : "-",
      status: p.status,
      approvals: p.approvals,
      rejections: p.rejections,
      paid: p.paid,
      hasVoted: p.hasVoted
    };
    detailBox.textContent = JSON.stringify(obj, null, 2);

    const now = Date.now();
    const afterDeadline = p.reviewDeadline && p.reviewDeadline.getTime() <= now;

    const canVote =
      isReviewer &&
      p.status === "Submitted" &&
      !p.hasVoted &&
      !afterDeadline;

    btnApprove.disabled = !canVote;
    btnReject.disabled = !canVote;

    if (!voteHint) return;

    if (!isReviewer) {
      voteHint.textContent = "Your connected wallet does not have REVIEWER_ROLE on this contract.";
    } else if (p.status !== "Submitted") {
      voteHint.textContent = "Voting is only allowed when status is Submitted.";
    } else if (p.hasVoted) {
      voteHint.textContent = "You have already voted on this proposal.";
    } else if (afterDeadline) {
      voteHint.textContent = "The review deadline has passed; voting is closed.";
    } else {
      voteHint.textContent = "You can vote on this proposal.";
    }
  }

  function selectProposal(id) {
    selectedId = Number(id);
    renderList();
    renderDetails();
  }

  async function reloadProposals() {
    try {
      contract = getContract();
      if (!signer) {
        log("Connect wallet first.");
        return;
      }
      const count = await contract.proposalCount();
      const n = Number(count);
      if (!n) {
        proposals = [];
        renderList();
        renderDetails();
        log("No proposals on chain.");
        return;
      }

      const arr = [];
      log("Loading proposals…");
      for (let i = 1; i <= n; i++) {
        const p = await contract.getProposal(i);
        const voted = await contract.hasVoted(i, user);
        arr.push(asProposalObj(i, p, voted));
      }

      // Show Submitted first, then others
      arr.sort((a,b) => {
        const order = (s) => s === "Submitted" ? 0 : s === "Approved" ? 1 : 2;
        return order(a.status) - order(b.status) || a.id - b.id;
      });

      proposals = arr;
      renderList();
      renderDetails();
      log("Loaded " + proposals.length + " proposals.");
    } catch (e) {
      console.error(e);
      log("Reload failed: " + (e?.reason || e?.message || e));
    }
  }

  async function castVote(approve) {
    if (!selectedId) {
      log("Select a proposal first.");
      return;
    }
    const p = proposals.find((x) => x.id === selectedId);
    if (!p) {
      log("Proposal not found in local list.");
      return;
    }
    if (!isReviewer) {
      log("Cannot vote: connected wallet is not a reviewer.");
      return;
    }

    try {
      contract = getContract();
      const id = BigInt(selectedId);
      log((approve ? "Approving" : "Rejecting") + " proposal #" + selectedId + "…");
      const tx = await contract.review(id, approve);
      log("Waiting for confirmation… " + tx.hash);
      await tx.wait();
      log("Vote recorded on-chain.");
      await reloadProposals();
      selectProposal(selectedId);
    } catch (e) {
      console.error(e);
      log("ERROR while voting: " + (e?.reason || e?.message || e));
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const inAddr = $("inAddr");
    if (inAddr) inAddr.value = loadAddr();

    if (window.ethereum) {
      provider = new ethers.BrowserProvider(window.ethereum);
      if (provider.pollingInterval != null) provider.pollingInterval = 2000;
      setConn("Wallet: Detected (not connected)");
    } else {
      setConn("Wallet: No provider", "#ef4444");
      log("MetaMask not found.");
    }

    bind("btnConnect", async () => {
      try { await ensureWallet(); }
      catch (e) { console.error(e); log("Connect failed: " + (e?.message || e)); }
    });

    bind("btnSaveAddr", () => {
      try {
        const addrEl = $("inAddr");
        const addr = (addrEl?.value || "").trim();
        if (!ethers.isAddress(addr)) throw new Error("Invalid address");
        saveAddr(addr);
        log("Saved contract address: " + addr);
      } catch (e) {
        log("Save failed: " + (e?.message || e));
      }
    });

    bind("btnReload", async () => {
      await reloadProposals();
    });

    bind("btnApprove", async () => {
      await castVote(true);
    });

    bind("btnReject", async () => {
      await castVote(false);
    });

    // click in list
    const listEl = $("list");
    if (listEl) {
      listEl.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        const row = target.closest(".listRow");
        if (!row) return;
        const id = Number(row.getAttribute("data-id"));
        if (!id) return;
        selectProposal(id);
      });
    }
  });
</script>
</body>
</html>
