<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Community Grants — Apply for Funding</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --card:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0;
    --accent:#1d4ed8; --accent-2:#1e40af; --ok:#15803d; --warn:#b45309; --bad:#b91c1c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .logo{width:12px;height:12px;border-radius:50%;background:var(--accent)}
  h1{font-size:20px;margin:0}
  main.wrap{padding-top:24px;padding-bottom:48px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1.2fr 1fr}}
  .stack{display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  .card h2{margin:0 0 12px 0;font-size:18px}
  .card h3{margin:10px 0 6px 0;font-size:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);outline:none}
  textarea{min-height:100px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--accent-2)}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  /* small pill-style button to match review page */
  .btn.sm{padding:6px 10px;font-size:12px;border-radius:999px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
  .status{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#fff;border:1px dashed var(--border);padding:10px;border-radius:10px}
  .muted{color:var(--muted);font-size:13px}
  .help li{margin-bottom:6px}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi .box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  small.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .logo-img {
    height: 50px;
    width: auto;
    display: block;
  }
  .brand {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
</style>
</head>
<body>
<header>
  <div class="wrap brand">
    <img src="open_grant.png" alt="OpenGrant Logo" class="logo-img" />
    <div class="row" style="justify-content:flex-end;flex:1">
      <!-- matches review page style -->
      <a href="review.html" class="btn secondary sm" style="text-decoration:none">Vote on Proposals</a>
      <span class="pill" id="pillConn">
        <span class="dot"></span><span>Wallet: Not connected</span>
      </span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT: Applicant actions -->
    <section class="card">
      <h2>Start your application</h2>
      <div class="row">
        <button class="btn" id="btnConnect">Connect Wallet</button>
        <button class="btn secondary" id="btnSwitch">Switch Account/Chain</button>
      </div>

      <div style="height:10px"></div>
      <label>GrantProposal Contract Address</label>
      <div class="row">
        <input id="inAddr" placeholder="0x..." />
        <button class="btn" id="btnSaveAddr">Save</button>
      </div>
      <div class="muted">Tip: your address is stored locally in your browser.</div>

      <div style="height:16px"></div>
      <div class="kpi">
        <div class="box">
          <div class="muted">Total Proposals</div>
          <div id="kpiCount" style="font-size:20px;font-weight:700">—</div>
        </div>
        <div class="box">
          <div class="muted">Your Submissions</div>
          <div id="kpiMine" style="font-size:20px;font-weight:700">—</div>
        </div>
      </div>

      <div style="height:18px"></div>
      <h3>Create a draft</h3>
      <label>Project Title</label>
      <input id="pTitle" placeholder="e.g., Community Garden Expansion" />
      <label>Details URL (IPFS/website)</label>
      <input id="pURI" placeholder="https://…" />
      <div class="row">
        <div style="flex:1">
          <label>Requested Amount (ETH)</label>
          <input id="pAmt" type="number" min="0" step="0.0001" placeholder="e.g., 3.5" />
        </div>
        <div style="flex:1">
          <label>Review Deadline</label>
          <input type="date" id="pDeadline" />
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="row">
        <button class="btn" id="btnCreate">Create Draft</button>
      </div>

      <div style="height:18px"></div>
      <h3>Update & Submit draft</h3>
      <div class="row">
        <input id="pId" type="number" min="1" placeholder="Your Proposal ID" />
        <button class="btn secondary" id="btnSubmit">Submit</button>
      </div>
      <div class="muted">Optional updates before submitting:</div>
      <div class="row">
        <input id="pTitle2" placeholder="New title (optional)" />
        <input id="pURI2" placeholder="New details URL (optional)" />
      </div>
      <div class="row">
        <input id="pAmt2" type="number" min="0" step="0.0001" placeholder="New amount (ETH)" />
        <input id="pDeadline2" type="datetime-local" />
        <button class="btn" id="btnUpdate">Update Draft</button>
      </div>
    </section>

    <!-- RIGHT COLUMN: Activity on top, Track & Learn below -->
    <div class="stack">
      <section class="card">
        <h2>Activity</h2>
        <div id="log" class="status">Ready.</div>
      </section>

      <section class="card">
        <h2>Track & Learn</h2>
        <div class="row">
          <input id="vpId" type="number" min="1" placeholder="View Proposal by ID" />
          <button class="btn secondary" id="btnView">View</button>
        </div>
        <div id="viewArea" class="status" style="margin-top:10px">Status will appear here.</div>

        <div style="height:18px"></div>
        <h3>Your proposals</h3>
        <div class="row">
          <button class="btn" id="btnLoadMine">Load My Proposals</button>
        </div>
        <div id="mineArea" class="status" style="margin-top:10px">—</div>

        <div style="height:18px"></div>
        <h3>Frequently asked</h3>
        <ul class="help muted">
          <li><b>What do I need?</b> A web3 wallet (e.g., MetaMask) and the contract address of this grant program.</li>
          <li><b>What is the review deadline?</b> The community must vote before that time; choose a reasonable window.</li>
          <li><b>When do funds arrive?</b> If approved, the program disburses ETH from the contract pool to your wallet.</li>
        </ul>
      </section>
    </div>
  </div>
</main>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.min.js";

  // --- Minimal ABI for applicant flows (GrantProposal) ---
  const ABI = [
    "function proposalCount() view returns (uint256)",
    "function getProposal(uint256 id) view returns (address,string,string,uint256,uint64,uint8,uint32,uint32,bool)",
    "function createProposal(string title,string metadataURI,uint256 requestedAmount,uint64 reviewDeadline) returns (uint256)",
    "function updateDraft(uint256 id,string title,string metadataURI,uint256 requestedAmount,uint64 reviewDeadline)",
    "function submit(uint256 id)",
    "event ProposalCreated(uint256 indexed id, address indexed proposer, string title, string metadataURI, uint256 requestedAmount, uint64 reviewDeadline)"
  ];

  // --- helpers ---
  const $ = (id) => document.getElementById(id);
  const log = (msg) => { const el = $("log"); if (el) { el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent; } };
  const setConn = (text, color) => {
    const pill = $("pillConn");
    if (!pill) return;
    pill.children[1].textContent = text;
    pill.children[0].style.background = color ?? "#cbd5e1";
  };
  const saveAddr = (addr) => localStorage.setItem("GRANT_ADDR", addr);
  const loadAddr = () => localStorage.getItem("GRANT_ADDR") || "0x355e11a1146505ee29a04831142dd24ec54bb259";

  const toWei = (eth) => ethers.parseEther(String(eth || "0"));
  const fromWei = (wei) => ethers.formatEther(wei);

  const bind = (id, handler) => {
    const tryAttach = () => {
      const el = $(id);
      if (el) { el.addEventListener('click', handler, false); return true; }
      return false;
    };
    if (!tryAttach()) {
      const iv = setInterval(() => { if (tryAttach()) clearInterval(iv); }, 50);
      setTimeout(() => clearInterval(iv), 5000);
    }
  };

  const dtToUnix = (inp) => {
    if (!inp || !inp.value) return 0n;
    const d = new Date(inp.value);
    d.setHours(23, 59, 59, 0);
    return BigInt(Math.floor(d.getTime() / 1000));
  };

  const STATUS = ["Draft","Submitted","Approved","Rejected","Cancelled","Funded"];

  let provider, signer, user, chainId;
  let contract;

  const getContract = () => {
    const addrEl = $("inAddr");
    const addr = (addrEl?.value || "").trim();
    if (!ethers.isAddress(addr)) throw new Error("Invalid contract address");
    return new ethers.Contract(addr, ABI, signer);
  };

  function displayProposal(id, p, el){
    const obj = {
      id: Number(id),
      proposer: p[0],
      title: p[1],
      detailsURL: p[2],
      requestedAmountETH: fromWei(p[3]),
      reviewDeadline: Number(p[4]) ? new Date(Number(p[4])*1000).toLocaleString() : "-",
      status: STATUS[p[5]] ?? `Unknown(${p[5]})`,
      approvals: Number(p[6]),
      rejections: Number(p[7]),
      paid: !!p[8]
    };
    if (el) el.textContent = JSON.stringify(obj, null, 2);
  }

  async function refreshKPIs(){
    try{
      contract = getContract();
      const count = await contract.proposalCount();
      const kpiCount = $("kpiCount");
      if (kpiCount) kpiCount.textContent = String(count);
      let mine = 0;
      const start = count > 200n ? count - 199n : 1n;
      for(let i=start; i<=count; i++){
        const p = await contract.getProposal(i);
        if (p[0].toLowerCase() === (user||"").toLowerCase()) mine++;
      }
      const kpiMine = $("kpiMine");
      if (kpiMine) kpiMine.textContent = String(mine);
    }catch{/* ignore if not ready */}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const inAddr = $("inAddr");
    if (inAddr) inAddr.value = loadAddr();

    if (window.ethereum){
      provider = new ethers.BrowserProvider(window.ethereum);
      if (provider?.pollingInterval != null) provider.pollingInterval = 2000;
      setConn("Wallet: Detected (not connected)");
    } else {
      setConn("Wallet: No provider", "#ef4444");
      log("MetaMask not found.");
    }

    bind("btnConnect", async () => {
      try{
        if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
        if (provider?.pollingInterval != null) provider.pollingInterval = 2000;
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        user = await signer.getAddress();
        const net = await provider.getNetwork();
        chainId = Number(net.chainId);
        setConn(`Wallet: ${user.slice(0,6)}…${user.slice(-4)} (chain ${chainId})`, "#22c55e");
        log(`Connected as ${user} on chain ${chainId}`);
        contract = getContract();
        await refreshKPIs();
      }catch(e){
        console.error(e); log("Connect failed: " + (e?.message||e));
        setConn("Wallet: Connect failed", "#ef4444");
      }
    });

    bind("btnSwitch", async () => {
      try{
        await provider.send("wallet_requestPermissions", [{ eth_accounts: {} }]);
        const btn = $("btnConnect"); if (btn) btn.click();
      }catch(e){ log("Switch failed: " + (e?.message||e)); }
    });

    bind("btnSaveAddr", () => {
      try{
        const addrEl = $("inAddr");
        const addr = (addrEl?.value || "").trim();
        if (!ethers.isAddress(addr)) throw new Error("Invalid address");
        saveAddr(addr);
        contract = getContract();
        log("Saved contract address: " + addr);
        refreshKPIs();
      }catch(e){ log("Save failed: " + (e?.message||e)); }
    });

    bind("btnCreate", async () => {
      try {
        contract = getContract();
        const title = ($("pTitle")?.value || "").trim();
        const uri   = ($("pURI")?.value || "").trim();
        const amt   = ethers.parseEther((($("pAmt")?.value) || "0").toString());
        let ddl     = dtToUnix($("pDeadline"));

        const now = BigInt(Math.floor(Date.now()/1000));
        if (ddl <= now) ddl = now + 86400n;
        if (!title || !uri || amt === 0n || ddl === 0n)
          throw new Error("All fields are required.");

        let expectedId = null;
        try { expectedId = (await contract.createProposal.staticCall(title, uri, amt, ddl)).toString(); } catch {}

        log("Submitting transaction…");
        const tx = await contract.createProposal(title, uri, amt, ddl);
        log(`Waiting for confirmation… (tx: ${tx.hash})`);

        let receipt;
        try { receipt = await tx.wait(); }
        catch (e) {
          if (e && (e.code === 'TRANSACTION_REPLACED' || e.code === 'CALL_EXCEPTION') && e.replacement) {
            log(`Transaction replaced: ${tx.hash} → ${e.replacement.hash}`);
            try { receipt = e.replacementReceipt ?? await e.replacement.wait(); } catch { log("Replacement wait failed, polling…"); }
          } else {
            log("wait() failed, polling… " + (e?.message || e));
          }
        }
        if (!receipt) {
          const mined = await provider.waitForTransaction(tx.hash, 1, 120_000).catch(() => null);
          if (mined) receipt = await provider.getTransactionReceipt(tx.hash);
        }
        if (!receipt) throw new Error("Timed out waiting for confirmation.");
        log(`Confirmed in block ${receipt.blockNumber}.`);

        let proposalId = null;
        try {
          for (const l of receipt.logs) {
            const logAddr = (l.address || l.source || "").toLowerCase();
            const target  = (contract.target || "").toLowerCase();
            if (logAddr && target && logAddr !== target) continue;
            const parsed = contract.interface.parseLog({ topics: l.topics, data: l.data });
            if (parsed?.name === "ProposalCreated") { proposalId = parsed.args[0].toString(); break; }
          }
        } catch {}

        if (!proposalId) {
          try {
            const evs = await contract.queryFilter(contract.filters.ProposalCreated(), receipt.blockNumber, receipt.blockNumber);
            let pick = evs.find(e => (e.args?.proposer || "").toLowerCase() === (user||"").toLowerCase());
            if (!pick && evs.length) pick = evs[evs.length - 1];
            if (pick?.args?.id != null) proposalId = pick.args.id.toString();
          } catch {}
        }
        if (!proposalId && expectedId) proposalId = expectedId;
        if (!proposalId) { try { proposalId = (await contract.proposalCount()).toString(); } catch {} }

        if (proposalId) {
          log(`✅ Proposal created! ID: ${proposalId}`);
          const pIdEl = $("pId"); if (pIdEl) pIdEl.value = proposalId;
          const vpIdEl = $("vpId"); if (vpIdEl) vpIdEl.value = proposalId;
        } else {
          log("✅ Proposal created! (Could not determine ID; check explorer logs.)");
        }

        await refreshKPIs();

      } catch (e) {
        log("Create failed: " + (e?.reason || e?.message || e));
        console.error(e);
      }
    });

    bind("btnUpdate", async () => {
      try{
        contract = getContract();
        const id  = BigInt(($("pId")?.value || "0"));
        if (id===0n) throw new Error("Proposal ID required.");
        const title = $("pTitle2")?.value || " ";
        const uri   = $("pURI2")?.value || " ";
        const amt   = $("pAmt2")?.value ? toWei($("pAmt2").value) : 0n;
        const ddlVal = $("pDeadline2")?.value;
        const ddl   = ddlVal ? BigInt(Math.floor(new Date(ddlVal).getTime()/1000)) : 0n;
        const tx = await contract.updateDraft(id, title, uri, amt, ddl);
        log("Updating draft… " + tx.hash);
        await tx.wait();
        log("Draft updated.");
      }catch(e){ log("Update failed: " + (e?.message||e)); }
    });

    bind("btnSubmit", async () => {
      try{
        contract = getContract();
        const id = BigInt(($("pId")?.value || "0"));
        if (id===0n) throw new Error("Proposal ID required.");
        const tx = await contract.submit(id);
        log("Submitting… " + tx.hash);
        await tx.wait();
        log("Proposal submitted for review.");
        await refreshKPIs();
      }catch(e){ log("Submit failed: " + (e?.message||e)); }
    });

    bind("btnView", async () => {
      try{
        contract = getContract();
        const id = BigInt(($("vpId")?.value || "0"));
        if (id===0n) throw new Error("Proposal ID required.");
        const p = await contract.getProposal(id);
        displayProposal(id, p, $("viewArea"));
        log("Loaded proposal " + id);
      }catch(e){ log("View failed: " + (e?.message||e)); }
    });

    bind("btnLoadMine", async () => {
      try{
        contract = getContract();
        if (!user) throw new Error("Connect your wallet first.");
        const count = await contract.proposalCount();
        if (count === 0n) { const m=$("mineArea"); if(m) m.textContent="No proposals yet."; const km=$("kpiMine"); if(km) km.textContent="0"; return; }
        const start = 1n;
        const lines = [];
        let mine = 0;
        for (let i=start; i<=count; i++){
          const p = await contract.getProposal(i);
          if (p[0].toLowerCase() === (user||"").toLowerCase()){
            mine++;
            const line = `#${i} — ${STATUS[p[5]] ?? "Unknown"} — ${p[1]} — ${fromWei(p[3])} ETH — deadline ${Number(p[4]) ? new Date(Number(p[4])*1000).toLocaleDateString() : "-"}`;
            lines.push(line);
          }
        }
        const mineArea = $("mineArea");
        if (mineArea) mineArea.textContent = lines.length ? lines.join("\n") : "You have not created any proposals.";
        const kpiMine = $("kpiMine");
        if (kpiMine) kpiMine.textContent = String(mine);
        log("Loaded your proposals.");
      }catch(e){ log("Load mine failed: " + (e?.message||e)); }
    });
  });
</script>
</body>
</html>
